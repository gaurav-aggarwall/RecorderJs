<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

</head>

<body>
  <button id="record">RECORD</button>
  <button id="stop">STOP</button>
  <button id="send">SEND</button>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/addons/p5.sound.js"></script>
  <script>
    function convertToWav(audioBuffer) {
      var leftChannel, rightChannel;
      leftChannel = audioBuffer.getChannelData(0);

      // handle mono files
      if (audioBuffer.numberOfChannels > 1) {
        rightChannel = audioBuffer.getChannelData(1);
      } else {
        rightChannel = leftChannel;
      }

      var interleaved = interleave(leftChannel, rightChannel);

      // create the buffer and view to create the .WAV file
      var buffer = new window.ArrayBuffer(44 + interleaved.length * 2);
      var view = new window.DataView(buffer);

      // write the WAV container,
      // check spec at: https://web.archive.org/web/20171215131933/http://tiny.systems/software/soundProgrammer/WavFormatDocs.pdf

      // RIFF chunk descriptor
      writeUTFBytes(view, 0, 'RIFF');
      view.setUint32(4, 36 + interleaved.length * 2, true);
      writeUTFBytes(view, 8, 'WAVE');
      // FMT sub-chunk
      writeUTFBytes(view, 12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      // stereo (2 channels)
      view.setUint16(22, 2, true);
      view.setUint32(24, 44100, true);
      view.setUint32(28, 44100 * 4, true);
      view.setUint16(32, 4, true);
      view.setUint16(34, 16, true);
      // data sub-chunk
      writeUTFBytes(view, 36, 'data');
      view.setUint32(40, interleaved.length * 2, true);

      // write the PCM samples
      var lng = interleaved.length;
      var index = 44;
      var volume = 1;
      for (var i = 0; i < lng; i++) {
        view.setInt16(index, interleaved[i] * (0x7FFF * volume), true);
        index += 2;
      }

      return view;
    }

    // helper methods to save waves
    function interleave(leftChannel, rightChannel) {
      var length = leftChannel.length + rightChannel.length;
      var result = new Float32Array(length);

      var inputIndex = 0;

      for (var index = 0; index < length;) {
        result[index++] = leftChannel[inputIndex];
        result[index++] = rightChannel[inputIndex];
        inputIndex++;
      }
      return result;
    }

    function writeUTFBytes(view, offset, string) {
      var lng = string.length;
      for (var i = 0; i < lng; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
      }
    }
  </script>
  <script type="text/javascript">
    var update_plot = function (file) {
      var formData = new FormData()
      formData.append("audio", file);

      console.log('File : '+ file);
      console.log('Form Data : '+ formData);

      $.getJSON({
        url: "http://localhost:5000/pitch_track",
        method: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (data) {
          console.log(data)
        }
      })

    }
  </script>
  <script>
    var mic, recorder, soundFile;

    function setup() {
      mic = new p5.AudioIn();
      mic.start();
      recorder = new p5.SoundRecorder();
      recorder.setInput(mic);
      soundFile = new p5.SoundFile();
      console.log(mic)
      console.log(recorder)
    }
    $('#record').click(function (e) {
      console.log(mic.enabled)
      if (mic.enabled) {
        console.log("recording")
        recorder.record(soundFile);
      }
    })
    $('#stop').click(function (e) {
      recorder.stop()
      console.log("stopped")
    })
    $('#send').click(function (e) {
      console.log("sending recording")
      const dataView = convertToWav(soundFile.buffer)
      const blob = new Blob([dataView], {
        type: 'audio/wav'
      })
      var file = new File([blob], "sound.wav")
      update_plot(file);
    })

    setup();
  </script>
</body>

</html>